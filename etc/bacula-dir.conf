#
# Configuração base do Director
#
Director {
  Name = "bacula-dir"
  Messages = "Daemon"
  QueryFile = "/opt/bacula/scripts/query.sql"
  WorkingDirectory = "/opt/bacula/working"
  PidDirectory = "/opt/bacula/working"
  MaximumConcurrentJobs = 20
  Password = "Hwx0Hk-TmK5b3wXXUfqIpi_xdk8DU1epS"
}
#
# Catálogo
#
Catalog {
  Name = "MyCatalog"
  Address = "db"
  Password = "bacula"
  User = "bacula"
  DbName = "bacula"
}
#
# Clients
#
Client {
  Name = "bacula-fd"
  Address = "bacula-fd"
  FdPort = 9102
  Password = "XXEELaODFgbgxlrGQeQT9thSunefXicas"
  Catalog = "MyCatalog"
  FileRetention = 60d
  JobRetention = 6m
  AutoPrune = yes
}
# Cliente destino de restauração emergencial
Client {
  Name = "Restorer-fd"
  Address = "192.168.64.19"
  FdPort = 9102
  Password = "XXEELaODFgbgxlrGQeQT9thSunefXicas"
  Catalog = "MyCatalog"
  FileRetention = 5184000
  JobRetention = 15552000
  AutoPrune = yes
}

#
# Jobs
#
Job {
  Name = "Bacula-Catalog-job"
  Level = "Full"
  Fileset = "Catalog"
  Schedule = "Diario-Catalog-sched"
  JobDefs = "Bacula-defjob"
  WriteBootstrap = "/opt/bacula/working/%n.bsr"
  Runscript {
    RunsWhen = "Before"
    RunsOnClient = no
    Command = "/opt/bacula/scripts/make_catalog_backup.pl MyCatalog"
  }
  Runscript {
    RunsWhen = "After"
    RunsOnClient = no
    Command = "/opt/bacula/scripts/delete_catalog_backup"
  }
  Priority = 11
}
Job {
  Name = "Bacula-Config-job"
  JobDefs = "Bacula-defjob"
}
Job {
  Name = "Bacula-Restore-job"
  Type = "Restore"
  Messages = "Standard"
  Storage = "Restore-storage"
  Pool = "BaculaExclusive-File-pool"
  Client = "bacula-fd"
  Fileset = "Bacula-fileset"
  Where = "/var/lib/bacula/bacula-restores"
}

#
# Storages
#
# Para backups Full e VFull
Storage {
  Name = "Bacula-sd-Autochanger1-storage"
  SdPort = 9103
  Address = "bacula-sd"
  Password = "l2JSrv-Nu5lgPrNMYh0r2jFM6aYdPxWhO"
  Device = "Bacula-sd-autochanger1"
  MediaType = "File-1"
  Autochanger = yes
  #Soma do Max concurrent job dos devices
  MaximumConcurrentJobs = 20 
}
# Para backups Diff e Incrementais
Storage {
  Name = "Bacula-sd-Autochanger2-storage"
  SdPort = 9103
  Address = "bacula-sd"
  Password = "l2JSrv-Nu5lgPrNMYh0r2jFM6aYdPxWhO"
  Device = "Bacula-sd-autochanger2"
  MediaType = "File-2"
  Autochanger = yes
  #Soma do Max concurrent job dos devices
  MaximumConcurrentJobs = 20 
}
Storage {
  Name = "Restore-storage"
  SdPort = 9103
  Address = "bacula-sd"
  Password = "l2JSrv-Nu5lgPrNMYh0r2jFM6aYdPxWhO"
  Device = "Restore-File-device1"
  MediaType = "FileRestore-1"
  MaximumConcurrentJobs = 10
}
Storage {
  Name = "RNP-BucketTeste-Cloud-storage"
  SdPort = 9103
  Address = "bacula-sd"
  Password = "l2JSrv-Nu5lgPrNMYh0r2jFM6aYdPxWhO"
  Device = "RNP-BucketTeste-Cloud-device1"
  MediaType = "Cloud-1"
  HeartbeatInterval = 300
  MaximumConcurrentJobs = 5
}
Storage {
  Name = "RNP-BucketCritico-Cloud-storage"
  SdPort = 9103
  Address = "bacula-sd"
  Password = "l2JSrv-Nu5lgPrNMYh0r2jFM6aYdPxWhO"
  Device = "RNP-BucketCritico-Cloud-device1"
  MediaType = "Cloud-2"
  HeartbeatInterval = 300
  MaximumConcurrentJobs = 5
}
Storage {
  Name = "RNP-BucketNaoCritico-Cloud-storage"
  SdPort = 9103
  Address = "bacula-sd"
  Password = "l2JSrv-Nu5lgPrNMYh0r2jFM6aYdPxWhO"
  Device = "RNP-BucketNaoCritico-Cloud-device1"
  MediaType = "Cloud-3"
  HeartbeatInterval = 300
  MaximumConcurrentJobs = 5
}

#
# Schedules
#
Schedule {
  Name = "Mensal-Default-sched"
  Run = Level="Full" 1st sun at 21:05
  Run = Level="VirtualFull" 2nd,3rd,4th,5th sun at 22:05
  Run = Level="Incremental" mon,tue,wed,thu,fri,sat at 22:05
}
Schedule {
  Name = "Mensal-AtivoCritico-Default-sched"
  Run = Level="Full" 1st sun at 23:05
  Run = Level="VirtualFull" 2nd,3rd,4th,5th sun at 23:05
  Run = Level="Incremental" mon,tue,wed,thu,fri,sat at 23:05
}
Schedule {
  Name = "Mensal-AtivoNaoCritico-Default-sched"
  Run = Level="Full" 1st sun at 01:05
  Run = Level="VirtualFull" 2nd,3rd,4th,5th sun at 01:05
  Run = Level="Incremental" mon,tue,wed,thu,fri,sat at 01:05
}
Schedule {
  Name = "DezMinutos-SuperCritico-Default-sched"
  Run = Level="Incremental" hourly at 0:05
  Run = Level="Incremental" hourly at 0:15
  Run = Level="Incremental" hourly at 0:25
  Run = Level="Incremental" hourly at 0:35
  Run = Level="Incremental" hourly at 0:45
  Run = Level="Incremental" hourly at 0:55
}
# O backup do catálogo deve sempre ocorrer após todos os demais
Schedule {
  Name = "Diario-Catalog-sched"
  Run = Level="Full" at 01:50
}

#
# Filesets
#
Fileset {
  Name = "Catalog"
  Include {
    File = "/opt/bacula/working/bacula.sql"
    Options {
      Signature = "Md5"
    }
  }
}
Fileset {
  Name = "Bacula-fileset"
  Include {
    File = "/opt/bacula/bin"
    Options {
      Signature = "Md5"
    }
  }
  Exclude {
    File = "/opt/bacula/working"
    File = "/var/lib/bacula"
    File = "/proc"
    File = "/tmp"
    File = "/sys"
    File = "/.journal"
    File = "/.fsck"
  }
}
Fileset {
  Name = "Modelo-fileset"
  Include {
    File = "/var/syslog"
    Options {
      Signature = "Sha1"
    }
  }
  Exclude {
    File = "/tmp"
  }
}

#
# Pools
#
# Pool exclusivo para backups do próprio Bacula
Pool { 
  Name = "BaculaExclusive-File-pool"
  PoolType = "Backup"
  LabelFormat = "BVol-${Year}-${Month:p/2/0/r}-${Day:p/2/0/r}"
  MaximumVolumes = 10
  MaximumVolumeBytes = 50g
  VolumeRetention = 365d
  AutoPrune = yes
  Recycle = yes
}
#
# Pool para backups full
Pool {
  Name = "Bacula-sd-File-Full-pool"
  PoolType = "Backup"
  LabelFormat = "FVol-${Year}-${Month:p/2/0/r}-${Day:p/2/0/r}"
  MaximumVolumes = 25
# 50GB
  MaximumVolumeBytes = 53687091200
# 365 dias em seg
  VolumeRetention = 365d
  AutoPrune = yes
  Recycle = yes
  NextPool = "Bacula-sd-File-VirtualFull-pool"
}
#
# Pool para backups diferenciais
Pool {
  Name = "Bacula-sd-File-Diff-pool"
  PoolType = "Backup"
  LabelFormat = "DVol-${Year}-${Month:p/2/0/r}-${Day:p/2/0/r}"
  MaximumVolumes = 25
  MaximumVolumeBytes = 53687091200
# 31 dias
  VolumeRetention = 2678400
  AutoPrune = yes
  Recycle = yes
  NextPool = "Bacula-sd-File-VirtualFull-pool"
}
#
# Pool para backups incrementais
Pool {
  Name = "Bacula-sd-File-Incr-pool"
  PoolType = "Backup"
  LabelFormat = "IVol-${Year}-${Month:p/2/0/r}-${Day:p/2/0/r}"
  MaximumVolumes = 25
# 25GB
  MaximumVolumeBytes = 26843545600
# 8 dias
  VolumeRetention = 691200
  AutoPrune = yes
  Recycle = yes
  NextPool = "Bacula-sd-File-VirtualFull-pool"
}
#
# Pool para backups full sintéticos
Pool {
  Name = "Bacula-sd-File-VirtualFull-pool"
  PoolType = "Backup"
  LabelFormat = "VFVol-${Year}-${Month:p/2/0/r}-${Day:p/2/0/r}"
  MaximumVolumes = 25
  MaximumVolumeBytes = 53687091200
# 31 dias
  VolumeRetention = 2678400
  AutoPrune = yes
  Recycle = yes
}
#
# Pool para backups na nuvem
Pool {
  Name = "RNPCloud-S3-Full-pool"
  PoolType = "Backup"
  LabelFormat = "Vol-${Year}-${Month:p/2/0/r}-${Day:p/2/0/r}"
  MaximumVolumes = 10
# 10 GB
  MaximumVolumeBytes = 10737418200
  VolumeRetention = 31536000
  AutoPrune = yes
  Recycle = yes
}
Pool {
  Name = "Scratch"
  PoolType = "Backup"
  VolumeRetention = 31d
}
#
# Messages
#
Messages {
  Name = "Daemon"
  MailCommand = "/opt/bacula/bin/bsmtp -h localhost -f \"(Bacula) <%r>\" -s \"Bacula daemon message\" %r"
  Mail = root = All, !Skipped
  Append = /opt/bacula/log/bacula.log = All, !Skipped
  Console = All, !Skipped
}
Messages {
  Name = "Standard"
  MailCommand = "/opt/bacula/bin/bsmtp -h localhost -f \"(Bacula) <%r>\" -s \"Bacula: %t %e of %c %l\" %r"
  OperatorCommand = "/opt/bacula/bin/bsmtp -h localhost -f \"(Bacula) <%r>\" -s \"Bacula: Intervention needed for %j\" %r"
  Mail = root = All, !Skipped
  Append = /opt/bacula/log/bacula.log = All, !Skipped
  Console = All, !Skipped
  Operator = root = Mount
  Catalog = All
}

#
# Console
#
Console {
  Name = "bacula-mon"
  Password = "eE5PUA5tonNv1ewEF2zT2VxQL-kXM7GX7"
  CommandAcl = "status"
  CommandAcl = ".status"
}

#
# Job Default Definitions
#
JobDefs {
  Name = "Bacula-defjob"
  Type = "Backup"
  Level = "Incremental"
  Messages = "Standard"
  Storage = "Bacula-sd-Autochanger1-storage"
  Pool = "BaculaExclusive-File-pool"
  Client = "bacula-fd"
  Fileset = "Bacula-fileset"
  Schedule = "Mensal-Default-sched"
  WriteBootstrap = "/opt/bacula/working/%c.bsr"
  SpoolAttributes = yes
  Priority = 12
}
JobDefs {
  Name = "AtivoCritico-defjob"
  Type = "Backup"
  Schedule = "Mensal-AtivoCritico-Default-sched"
  MaxStartDelay = 1h
  Messages = "Standard"
  WriteBootstrap = "/opt/bacula/working/%c.bsr"
  SpoolAttributes = yes
  Priority = 10
}
JobDefs {
  Name = "AtivoNaoCritico-defjob"
  Type = "Backup"
  Schedule = "Mensal-AtivoNaoCritico-Default-sched"
  MaxStartDelay = 1h
  Messages = "Standard"
  WriteBootstrap = "/opt/bacula/working/%c.bsr"
  SpoolAttributes = yes
  Priority = 11
}
